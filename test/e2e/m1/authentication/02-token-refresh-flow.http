### M1 - Authentication: Token Refresh Flow
### Description: Refresh access token using refresh token

@baseUrl=http://localhost:3001/api/v1
@email=super@admin.in
@password=SuperAdmin123!

@accessToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg4NmIzNTY5NDE4MTkxYzY4OGQ5ZTgiLCJlbWFpbCI6InN1cGVyQGFkbWluLmluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiaWF0IjoxNzcwNjI0NTI5LCJleHAiOjE3NzA3MTA5Mjl9.3I_vbnumLIiI_tINa5iXRmx7oCQJJwTdmez0Xe5M8Zg
@refreshToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg4NmIzNTY5NDE4MTkxYzY4OGQ5ZTgiLCJlbWFpbCI6InN1cGVyQGFkbWluLmluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiaWF0IjoxNzcwNjI0NTI5LCJleHAiOjE3NzEyMjkzMjl9.P0K3QF60uUT8MGDSpCnXilXhENTTad8Rwg1UFmzpW6E
@userId = 69886b3569418191c688d9e8

# Save new tokens
@newAccessToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg4NmIzNTY5NDE4MTkxYzY4OGQ5ZTgiLCJlbWFpbCI6InN1cGVyQGFkbWluLmluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiaWF0IjoxNzcwNjI0ODEyLCJleHAiOjE3NzA3MTEyMTJ9.NATCtckgWRtgJlLdKp2P7Ltx_AJdJb6Om3yDyzx4ThM
@newRefreshToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg4NmIzNTY5NDE4MTkxYzY4OGQ5ZTgiLCJlbWFpbCI6InN1cGVyQGFkbWluLmluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiaWF0IjoxNzcwNjI0ODEyLCJleHAiOjE3NzEyMjk2MTJ9.QeRAFyhHGELs4vXgXVoGj1bwiEYV_iu829xAe_GHTkE


###############################################################################
# 1. Initial Login
###############################################################################

### 1.1 Login to get tokens
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}


###############################################################################
# 2. Use Access Token
###############################################################################

### 2.1 Access protected resource with valid token
GET {{baseUrl}}/auth/profile
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 200 OK
# - Returns user profile

###############################################################################
# 3. Refresh Access Token
###############################################################################

### 3.1 Refresh token before expiry
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refresh_token": "{{refreshToken}}"
}

# Expected Response:
# - 200 OK
# - Returns new accessToken and refreshToken
# - Old tokens are invalidated



###############################################################################
# 4. Verify New Token Works
###############################################################################

### 4.1 Use new access token
GET {{baseUrl}}/auth/profile
Authorization: Bearer {{newAccessToken}}

# Expected Response:
# - 200 OK
# - Returns user profile

###############################################################################
# 5. Verify Old Token is Invalidated
###############################################################################

### 5.1 Try to use old access token
GET {{baseUrl}}/auth/profile
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 401 Unauthorized
# - Token is no longer valid

###############################################################################
# 6. Error Cases
###############################################################################

### 6.1 Refresh with invalid token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refresh_token": "invalid-token-string"
}

# Expected Response:
# - 401 Unauthorized
# - Error code: AUTH_003
# - Message: Invalid token

### 6.2 Refresh with expired token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyMzkwMjJ9.4Adcj0vfIRa7BHvqRJH6B6Jv8JZXvz5pXJ5Jv8JZXvz"
}

# Expected Response:
# - 401 Unauthorized
# - Error code: AUTH_002
# - Message: Token expired

### 6.2b Refresh with malformed token (invalid base64 payload)
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.expired.token"
}

# Expected Response:
# - 401 Unauthorized
# - Error code: AUTH_003
# - Message: Invalid token

### 6.3 Refresh with missing token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
}

# Expected Response:
# - 400 Bad Request
# - Validation error: refreshToken is required

###############################################################################
# 7. Automatic Token Refresh Simulation
###############################################################################

### 7.1 Access resource with expired token (should trigger auto-refresh)
# Note: This simulates the frontend's automatic token refresh mechanism
# In practice, the frontend intercepts 401 responses and refreshes automatically

GET {{baseUrl}}/auth/profile
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg4NmIzNTY5NDE4MTkxYzY4OGQ5ZTgiLCJlbWFpbCI6InN1cGVyQGFkbWluLmluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiaWF0IjoxNzcwNjI0NTI5LCJleHAiOjE3NzEyMjkzMjl9.P0K3QF60uUT8MGDSpCnXilXhENTTad8Rwg1UFmzpW6E

# Expected Response:
# - 401 Unauthorized
# - Frontend should catch this and call /auth/refresh
# - Then retry the original request with new token
