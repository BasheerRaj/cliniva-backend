### M1 - Authentication: Password Management Flow
### Description: Change password, forgot password, reset password

@baseUrl = http://localhost:3001/api/v1
@email = testuser@cliniva.com
@password = ResetPassword@123
@newPassword = Password@123

@accessToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2OTg5YjdjOTg4NDc5YWM0N2FhZmUwZWUiLCJlbWFpbCI6InRlc3R1c2VyQGNsaW5pdmEuY29tIiwicm9sZSI6Im93bmVyIiwiaWF0IjoxNzcwNjMzMzAzLCJleHAiOjE3NzA3MTk3MDN9.r3OLAgaiEjqCjwqmLjRUuwglky6btlC5JmvXx9WAkwU

@resetToken = d4a7e005bdf14b2d8a57a7a88d7d2e3bcd571a02ecd8c8b899eaae890093aaab
###############################################################################
# 1. Change Password (Logged In User)
###############################################################################

### 1.1 Login first
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}


### 1.2 Change password successfully
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "{{password}}",
  "newPassword": "{{newPassword}}",
  "confirmPassword": "{{newPassword}}"
}

# Expected Response:
# - 200 OK
# - Success message in Arabic and English
# - Password updated successfully

### 1.3 Verify old password no longer works
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

# Expected Response:
# - 401 Unauthorized
# - Invalid credentials

### 1.4 Login with new password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{newPassword}}"
}

# Expected Response:
# - 200 OK
# - Login successful with new password

###############################################################################
# 2. Change Password - Error Cases
###############################################################################

### 2.1 Change password with wrong current password
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "WrongPassword123",
  "newPassword": "{{newPassword}}",
  "confirmPassword": "{{newPassword}}"
}

# Expected Response:
# - 400 Bad Request
# - Error: Current password is incorrect

### 2.2 Change password with mismatched confirmation
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "{{newPassword}}",
  "newPassword": "AnotherPassword@123",
  "confirmPassword": "DifferentPassword@123"
}

# Expected Response:
# - 400 Bad Request
# - Error: Passwords do not match

### 2.3 Change password with weak password
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "currentPassword": "{{newPassword}}",
  "newPassword": "weak",
  "confirmPassword": "weak"
}

# Expected Response:
# - 400 Bad Request
# - Error: Password must be at least 8 characters

### 2.4 Change password without authentication
POST {{baseUrl}}/auth/change-password
Content-Type: application/json

{
  "currentPassword": "{{newPassword}}",
  "newPassword": "AnotherPassword@123",
  "confirmPassword": "AnotherPassword@123"
}

# Expected Response:
# - 401 Unauthorized
# - No token provided

###############################################################################
# 3. Forgot Password Flow
###############################################################################

### 3.1 Request password reset
POST {{baseUrl}}/auth/forgot-password
Content-Type: application/json

{
  "email": "{{email}}"
}

# Expected Response:
# - 200 OK
# - Success message: Password reset link sent to email
# - Email sent with reset token

# Note: Check email for reset link
# Link format: http://frontend-url/reset-password?token=RESET_TOKEN
# @resetToken = <copy_token_from_email_link>

### 3.2 Request password reset for non-existent email
POST {{baseUrl}}/auth/forgot-password
Content-Type: application/json

{
  "email": "nonexistent@cliniva.com"
}

# Expected Response:
# - 200 OK (for security, don't reveal if email exists)
# - Same success message
# - No email sent

### 3.3 Request password reset with invalid email format
POST {{baseUrl}}/auth/forgot-password
Content-Type: application/json

{
  "email": "not-an-email"
}

# Expected Response:
# - 400 Bad Request
# - Validation error: Invalid email format

###############################################################################
# 4. Reset Password Flow
###############################################################################

### 4.1 Reset password with valid token
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "ResetPassword@123",
  "confirmPassword": "ResetPassword@123"
}

# Expected Response:
# - 200 OK
# - Success message: Password reset successful
# - User can now login with new password

### 4.2 Login with reset password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "ResetPassword@123"
}

# Expected Response:
# - 200 OK
# - Login successful

### 4.3 Reset password with invalid token
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "token": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6",
  "newPassword": "NewPassword@123",
  "confirmPassword": "NewPassword@123"
}

# Expected Response:
# - 400 Bad Request
# - Error code: PASSWORD_RESET_TOKEN_INVALID
# - Message: Password reset token is invalid
# Note: Token must be 32+ characters to pass DTO validation

### 4.4 Reset password with expired token
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "token": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
  "newPassword": "NewPassword@123",
  "confirmPassword": "NewPassword@123"
}

# Expected Response:
# - 400 Bad Request
# - Error code: PASSWORD_RESET_TOKEN_EXPIRED
# - Message: Password reset token has expired
# Note: Token must be 32+ characters to pass DTO validation

### 4.5 Reset password with mismatched passwords
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NewPassword@123",
  "confirmPassword": "DifferentPassword@123"
}

# Expected Response:
# - 400 Bad Request
# - Error: Passwords do not match

### 4.6 Try to reuse reset token
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "AnotherPassword@123",
  "confirmPassword": "AnotherPassword@123"
}

# Expected Response:
# - 400 Bad Request
# - Error: Token already used or invalid

###############################################################################
# 5. First Login Password Change (Future Implementation)
###############################################################################

### 5.1 First login password change
# Note: This endpoint is not yet implemented
# POST {{baseUrl}}/auth/first-login-password-change
# Authorization: Bearer {{accessToken}}
# Content-Type: application/json
#
# {
#   "currentPassword": "temporary-password",
#   "newPassword": "NewSecurePassword@123",
#   "confirmPassword": "NewSecurePassword@123"
# }

# Expected Response:
# - 200 OK
# - isFirstLogin flag set to false
# - User can now access system normally
