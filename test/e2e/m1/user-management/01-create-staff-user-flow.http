### M1 - User Management: Create Staff User Flow
### Use Case: UC-7a6b5c4 - Create Staff User
### Description: Complete flow to create a staff user with all required information

@baseUrl = http://localhost:3001
@adminEmail = admin@cliniva.com
@adminPassword = Admin@123

###############################################################################
# 1. Admin Login
###############################################################################

### 1.1 Login as admin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{adminEmail}}",
  "password": "{{adminPassword}}"
}

@accessToken = <copy_access_token_from_response>
@subscriptionId = <copy_subscription_id_from_response>
@complexId = <copy_complex_id_from_response>
@clinicId = <copy_clinic_id_from_response>

###############################################################################
# 2. Get Available Complexes and Clinics
###############################################################################

### 2.1 Get complexes for dropdown
GET {{baseUrl}}/complexes?subscriptionId={{subscriptionId}}
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 200 OK
# - List of complexes for selection

### 2.2 Get clinics by complex
GET {{baseUrl}}/clinics?complexId={{complexId}}
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 200 OK
# - List of clinics within the selected complex

###############################################################################
# 3. Create Staff User - Success Case
###############################################################################

### 3.1 Create staff user with complete information
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "staff.member@cliniva.com",
  "firstName": "Ahmed",
  "lastName": "Hassan",
  "phone": "+966501234567",
  "dateOfBirth": "1990-05-15",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "complexId": "{{complexId}}",
  "clinicId": "{{clinicId}}",
  "employeeProfile": {
    "jobTitle": "Receptionist",
    "dateOfHiring": "2024-01-15",
    "salary": 5000,
    "maritalStatus": "single",
    "numberOfChildren": 0,
    "bankAccount": "SA1234567890123456789012",
    "socialSecurityNumber": "1234567890",
    "taxId": "TAX123456"
  },
  "workingHours": [
    {
      "dayOfWeek": "sunday",
      "isWorkingDay": true,
      "openingTime": "08:00",
      "closingTime": "16:00"
    },
    {
      "dayOfWeek": "monday",
      "isWorkingDay": true,
      "openingTime": "08:00",
      "closingTime": "16:00"
    },
    {
      "dayOfWeek": "tuesday",
      "isWorkingDay": true,
      "openingTime": "08:00",
      "closingTime": "16:00"
    },
    {
      "dayOfWeek": "wednesday",
      "isWorkingDay": true,
      "openingTime": "08:00",
      "closingTime": "16:00"
    },
    {
      "dayOfWeek": "thursday",
      "isWorkingDay": true,
      "openingTime": "08:00",
      "closingTime": "16:00"
    },
    {
      "dayOfWeek": "friday",
      "isWorkingDay": false
    },
    {
      "dayOfWeek": "saturday",
      "isWorkingDay": false
    }
  ]
}

# Expected Response:
# - 201 Created
# - Returns user object with employee profile
# - Auto-generated employee number (e.g., EMP2024001)
# - Temporary password sent to email

@staffUserId = <copy_user_id_from_response>
@employeeId = <copy_employee_id_from_response>
@temporaryPassword = <copy_temporary_password_from_response>

###############################################################################
# 4. Verify Staff User Created
###############################################################################

### 4.1 Get staff user details
GET {{baseUrl}}/employees/{{employeeId}}
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 200 OK
# - Complete user and employee profile
# - Working hours included

### 4.2 Get user by ID
GET {{baseUrl}}/users/{{staffUserId}}
Authorization: Bearer {{accessToken}}

# Expected Response:
# - 200 OK
# - User details with relationships

###############################################################################
# 5. Staff User First Login
###############################################################################

### 5.1 Staff logs in with temporary password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "staff.member@cliniva.com",
  "password": "{{temporaryPassword}}"
}

# Expected Response:
# - 200 OK
# - Login successful
# - Should prompt for password change (future feature)

@staffAccessToken = <copy_access_token_from_response>

### 5.2 Staff changes password
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{staffAccessToken}}
Content-Type: application/json

{
  "currentPassword": "{{temporaryPassword}}",
  "newPassword": "StaffPassword@123",
  "confirmPassword": "StaffPassword@123"
}

# Expected Response:
# - 200 OK
# - Password changed successfully

###############################################################################
# 6. Create Staff User - Validation Errors
###############################################################################

### 6.1 Create user with missing required fields
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "incomplete@cliniva.com",
  "firstName": "Test"
}

# Expected Response:
# - 400 Bad Request
# - Validation errors for missing fields

### 6.2 Create user with invalid email format
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "not-an-email",
  "firstName": "Test",
  "lastName": "User",
  "phone": "+966501234567",
  "dateOfBirth": "1990-01-01",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "clinicId": "{{clinicId}}",
  "employeeProfile": {
    "jobTitle": "Staff",
    "dateOfHiring": "2024-01-01"
  }
}

# Expected Response:
# - 400 Bad Request
# - Error: Invalid email format

### 6.3 Create user with duplicate email
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "staff.member@cliniva.com",
  "firstName": "Duplicate",
  "lastName": "User",
  "phone": "+966501234568",
  "dateOfBirth": "1990-01-01",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "clinicId": "{{clinicId}}",
  "employeeProfile": {
    "jobTitle": "Staff",
    "dateOfHiring": "2024-01-01"
  }
}

# Expected Response:
# - 400 Bad Request
# - Error code: USER_001
# - Message: User already exists

### 6.4 Create user with future date of birth
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "future@cliniva.com",
  "firstName": "Future",
  "lastName": "User",
  "phone": "+966501234569",
  "dateOfBirth": "2030-01-01",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "clinicId": "{{clinicId}}",
  "employeeProfile": {
    "jobTitle": "Staff",
    "dateOfHiring": "2024-01-01"
  }
}

# Expected Response:
# - 400 Bad Request
# - Error: Date of birth cannot be in the future

### 6.5 Create user with invalid phone format
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "invalidphone@cliniva.com",
  "firstName": "Invalid",
  "lastName": "Phone",
  "phone": "123",
  "dateOfBirth": "1990-01-01",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "clinicId": "{{clinicId}}",
  "employeeProfile": {
    "jobTitle": "Staff",
    "dateOfHiring": "2024-01-01"
  }
}

# Expected Response:
# - 400 Bad Request
# - Error: Invalid phone format

###############################################################################
# 7. Business Rule Validations
###############################################################################

### 7.1 Create user without clinic (should fail for clinic plan)
POST {{baseUrl}}/employees
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "email": "noclinic@cliniva.com",
  "firstName": "No",
  "lastName": "Clinic",
  "phone": "+966501234570",
  "dateOfBirth": "1990-01-01",
  "gender": "male",
  "nationality": "Saudi Arabia",
  "role": "staff",
  "subscriptionId": "{{subscriptionId}}",
  "employeeProfile": {
    "jobTitle": "Staff",
    "dateOfHiring": "2024-01-01"
  }
}

# Expected Response:
# - 400 Bad Request
# - Error: Clinic is required for this subscription plan

### 7.2 Create user with clinic from different complex
# Note: This requires having multiple complexes
# POST {{baseUrl}}/employees
# Authorization: Bearer {{accessToken}}
# Content-Type: application/json
#
# {
#   "email": "wrongcomplex@cliniva.com",
#   "complexId": "complex1-id",
#   "clinicId": "clinic-from-complex2-id",
#   ...other fields
# }

# Expected Response:
# - 400 Bad Request
# - Error: Clinic must belong to the selected complex
